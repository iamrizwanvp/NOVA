{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOVA | Forgot Password</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { margin: 0; padding: 0; height: 100vh; background: url("{% static 'images/bg-login.jpg' %}") no-repeat center center/cover; position: relative; font-family: 'Poppins', sans-serif; }
    body::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1; }
    .auth-container { position: relative; z-index: 2; display: flex; justify-content: center; align-items: center; height: 100vh; }
    .auth-card { width: 100%; max-width: 400px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; backdrop-filter: blur(10px); padding: 2rem; color: #fff; animation: fadeIn 1s ease forwards; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
    .form-floating label { color: rgba(255,255,255,0.8); }
    .form-control { background: rgba(255,255,255,0.2); border: none; color: #fff; }
    .form-control:focus { background: rgba(255,255,255,0.3); color: #fff; outline: none; box-shadow: 0 0 5px #ff3d71; }
    .btn-auth { width: 100%; background: #e50914; border: none; color: white; font-weight: bold; padding: 0.75rem; border-radius: 8px; transition: all 0.3s ease; }
    .btn-auth:hover { background: #f40612; transform: scale(1.05); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    .auth-footer { font-size: 0.9rem; text-align: center; margin-top: 1rem; }
    .auth-footer a { color: #aaa; text-decoration: none; }
    .auth-footer a:hover { text-decoration: underline; color: #fff; }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-card">
      <h2 class="text-center mb-4">Forgot Password</h2>
      <form id="forgot-form">
        {% csrf_token %}
        <div class="form-floating mb-3">
          <input type="email" class="form-control" id="email" name="email" placeholder="name@example.com" required>
          <label for="email">Email address</label>
        </div>
        <button type="submit" class="btn btn-auth">Request OTP</button>
      </form>
      
      <!-- OTP + Reset Password form (hidden at first) -->
      <form id="reset-form" style="display:none; margin-top:20px;">
        {% csrf_token %}
        <div class="form-floating mb-3">
          <input type="text" class="form-control" id="otp" name="otp" placeholder="Enter OTP" required>
          <label for="otp">OTP</label>
        </div>
        <div class="form-floating mb-3">
          <input type="password" class="form-control" id="new_password" name="new_password" placeholder="New Password" required>
          <label for="new_password">New Password</label>
        </div>
        <button type="submit" class="btn btn-auth">Reset Password</button>
      </form>
      
      <div class="auth-footer mt-3">
        <p>Remembered your password? <a href="{% url 'login_page' %}">Login</a></p>
      </div>
    </div>
  </div>

  <!-- âœ… JavaScript -->
  <script>
    // Simple API helper
    async function apiFetch(url, options = {}) {
      const { body, ...rest } = options;
      const resp = await fetch(url, {
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: body ? JSON.stringify(body) : null,
        ...rest,
      });

      if (!resp.ok) {
        let errMsg = await resp.text();
        throw new Error(errMsg);
      }
      return resp.json();
    }

    let savedEmail = null;
    let sessionToken = null;

    const forgotForm = document.getElementById("forgot-form");
    const resetForm = document.getElementById("reset-form");

    // Step 1: Request OTP
    forgotForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      if (!email) return alert("Enter your email");

      try {
        await apiFetch("/users/api/password/request-otp/", {
          method: "POST",
          body: { email },
        });
        savedEmail = email;
        alert("âœ… OTP sent to your email!");
        forgotForm.style.display = "none";
        resetForm.style.display = "block";
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    // Step 2: Verify OTP + Reset Password
    resetForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const otp = document.getElementById("otp").value.trim();
      const new_password = document.getElementById("new_password").value;

      try {
        const verifyResp = await apiFetch("/users/api/password/verify-otp/", {
          method: "POST",
          body: { email: savedEmail, otp },
        });

        sessionToken = verifyResp.session_token;

        await apiFetch("/users/api/password/reset/", {
          method: "POST",
          body: { email: savedEmail, new_password, session_token: sessionToken },
        });

        alert("ðŸŽ‰ Password reset successful! Redirecting to login...");
        window.location.href = "/users/login/";
      } catch (err) {
        alert("Error: " + err.message);
      }
    });
  </script>
</body>
</html>
